# LangChain.js MCP é€‚é…å™¨

[![npm ç‰ˆæœ¬](https://img.shields.io/npm/v/@langchain/mcp-adapters.svg)](https://www.npmjs.com/package/@langchain/mcp-adapters)
[![è®¸å¯è¯: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

æœ¬åº“æä¾›äº†ä¸€ä¸ªè½»é‡çº§å°è£…ï¼Œä½¿ [Anthropic æ¨¡å‹ä¸Šä¸‹æ–‡åè®® (MCP)](https://modelcontextprotocol.io/introduction) å·¥å…·èƒ½å¤Ÿä¸ [LangChain.js](https://github.com/langchain-ai/langchainjs) å’Œ [LangGraph.js](https://github.com/langchain-ai/langgraphjs) å…¼å®¹ã€‚

## åŠŸèƒ½ç‰¹æ€§

* ğŸ”Œ **ä¼ è¾“é€‰é¡¹**

  * é€šè¿‡ stdioï¼ˆæœ¬åœ°ï¼‰æˆ–å¯æµå¼ HTTPï¼ˆè¿œç¨‹ï¼‰è¿æ¥åˆ° MCP æœåŠ¡å™¨
    * å¯æµå¼ HTTP ä¼šè‡ªåŠ¨å›é€€åˆ° SSEï¼Œä»¥å…¼å®¹æ—§ç‰ˆ MCP æœåŠ¡å™¨å®ç°
  * SSE è¿æ¥æ”¯æŒè‡ªå®šä¹‰è¯·æ±‚å¤´ç”¨äºèº«ä»½éªŒè¯
  * ä¸¤ç§ä¼ è¾“æ–¹å¼å‡æ”¯æŒå¯é…ç½®çš„é‡è¿ç­–ç•¥

* ğŸ”„ **å¤šæœåŠ¡å™¨ç®¡ç†**

  * å¯åŒæ—¶è¿æ¥åˆ°å¤šä¸ª MCP æœåŠ¡å™¨
  * å·¥å…·å¯æŒ‰æœåŠ¡å™¨è‡ªåŠ¨ç»„ç»‡ï¼Œæˆ–ä»¥æ‰å¹³åŒ–é›†åˆå½¢å¼è®¿é—®

* ğŸ§© **ä»£ç†é›†æˆ**

  * å…¼å®¹ LangChain.js å’Œ LangGraph.js
  * é’ˆå¯¹ OpenAIã€Anthropic å’Œ Google æ¨¡å‹è¿›è¡Œäº†ä¼˜åŒ–
  * æ”¯æŒå¯Œå†…å®¹å“åº”ï¼ŒåŒ…æ‹¬æ–‡æœ¬ã€å›¾åƒå’ŒåµŒå…¥èµ„æº

* ğŸ› ï¸ **å¼€å‘åŠŸèƒ½**
  * ä½¿ç”¨ `debug` åŒ…è¿›è¡Œè°ƒè¯•æ—¥å¿—è®°å½•
  * çµæ´»çš„é…ç½®é€‰é¡¹
  * å¼ºå¥çš„é”™è¯¯å¤„ç†æœºåˆ¶

## å®‰è£…æ–¹æ³•
```bash
npm install @langchain/mcp-adapters
```
# ç¤ºä¾‹ï¼šé€šè¿‡ `MultiServerMCPClient` è¿æ¥åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡å™¨

è¯¥åº“å…è®¸ä½ è¿æ¥åˆ°ä¸€ä¸ªæˆ–å¤šä¸ª MCP æœåŠ¡å™¨ï¼Œå¹¶ä»ä¸­åŠ è½½å·¥å…·ï¼Œè€Œæ— éœ€è‡ªè¡Œç®¡ç† MCP å®¢æˆ·ç«¯å®ä¾‹ã€‚
```ts
import { MultiServerMCPClient } from "@langchain/mcp-adapters";
import { ChatOpenAI } from "@langchain/openai";
import { createReactAgent } from "@langchain/langgraph/prebuilt";

// åˆ›å»ºå®¢æˆ·ç«¯å¹¶è¿æ¥åˆ°æœåŠ¡å™¨
const client = new MultiServerMCPClient({
  // å…¨å±€å·¥å…·é…ç½®é€‰é¡¹
  // å¦‚æœå·¥å…·åŠ è½½å¤±è´¥æ˜¯å¦æŠ›å‡ºé”™è¯¯ï¼ˆå¯é€‰ï¼Œé»˜è®¤ï¼štrueï¼‰
  throwOnLoadError: true,
  // æ˜¯å¦åœ¨å·¥å…·åç§°å‰æ·»åŠ æœåŠ¡å™¨åç§°ï¼ˆå¯é€‰ï¼Œé»˜è®¤ï¼šfalseï¼‰
  prefixToolNameWithServerName: false,
  // å·¥å…·åç§°çš„å¯é€‰é™„åŠ å‰ç¼€ï¼ˆå¯é€‰ï¼Œé»˜è®¤ï¼š""ï¼‰
  additionalToolNamePrefix: "",

  // åœ¨å·¥å…·è¾“å‡ºä¸­ä½¿ç”¨æ ‡å‡†åŒ–å†…å®¹å—æ ¼å¼
  useStandardContentBlocks: true,

  // æœåŠ¡å™¨é…ç½®
  mcpServers: {
    // æ·»åŠ ä¸€ä¸ªåä¸º"math"çš„STDIOè¿æ¥æœåŠ¡å™¨
    math: {
      transport: "stdio",
      command: "npx",
      args: ["-y", "@modelcontextprotocol/server-math"],
      // stdioä¼ è¾“çš„é‡å¯é…ç½®
      restart: {
        enabled: true,
        maxAttempts: 3,
        delayMs: 1000,
      },
    },

    // è¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»ŸæœåŠ¡å™¨
    filesystem: {
      transport: "stdio",
      command: "npx",
      args: ["-y", "@modelcontextprotocol/server-filesystem"],
    },

    // å¯æµå¼ä¼ è¾“çš„HTTPç¤ºä¾‹ï¼ŒåŒ…å«è®¤è¯å¤´ä¸”ç¦ç”¨è‡ªåŠ¨SSEå›é€€ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
    weather: {
      url: "https://example.com/weather/mcp",
      headers: {
        Authorization: "Bearer token123",
      },
      automaticSSEFallback: false
    },

    // OAuth 2.0è®¤è¯ï¼ˆæ¨èç”¨äºå®‰å…¨æœåŠ¡å™¨ï¼‰
    "oauth-protected-server": {
      url: "https://protected.example.com/mcp",
      authProvider: new MyOAuthProvider({
        // ä½ çš„OAuthæä¾›ç¨‹åºå®ç°
        redirectUrl: "https://myapp.com/oauth/callback",
        clientMetadata: {
          redirect_uris: ["https://myapp.com/oauth/callback"],
          client_name: "æˆ‘çš„MCPå®¢æˆ·ç«¯",
          scope: "mcp:read mcp:write"
        }
      }),
      // ä»å¯åŒ…å«éè®¤è¯ç”¨é€”çš„è‡ªå®šä¹‰å¤´
      headers: {
        "User-Agent": "My-MCP-Client/1.0"
      }
    },

    // å¦‚ä½•å¼ºåˆ¶ä½¿ç”¨SSEï¼Œé€‚ç”¨äºå·²çŸ¥ä»…æ”¯æŒSSEçš„æ—§æœåŠ¡å™¨ï¼ˆå¯æµå¼HTTPåœ¨ä¸ç¡®å®šæ—¶ä¼šè‡ªåŠ¨å›é€€ï¼‰
    github: {
      transport: "sse", // ä¹Ÿå¯ä»¥ä½¿ç”¨"type"å­—æ®µä»£æ›¿"transport"
      url: "https://example.com/mcp",
      reconnect: {
        enabled: true,
        maxAttempts: 5,
        delayMs: 2000,
      },
    },
  },
});

const tools = await client.getTools();

// åˆ›å»ºOpenAIæ¨¡å‹
const model = new ChatOpenAI({
  model: "gpt-4o-mini",
  temperature: 0,
});

// åˆ›å»ºReactä»£ç†
const agent = createReactAgent({
  llm: model,
  tools,
});

// è¿è¡Œä»£ç†
try {
  const mathResponse = await agent.invoke({
    messages: [{ role: "user", content: "(3 + 5) x 12ç­‰äºå¤šå°‘ï¼Ÿ" }],
  });
  console.log(mathResponse);
} catch (error) {
  console.error("ä»£ç†æ‰§è¡ŒæœŸé—´å‡ºé”™ï¼š", error);
  // å·¥å…·å¯¹ç‰¹å®šé”™è¯¯ä¼šæŠ›å‡ºToolException
  if (error.name === "ToolException") {
    console.error("å·¥å…·æ‰§è¡Œå¤±è´¥ï¼š", error.message);
  }
}

await client.close();
```
# ç¤ºä¾‹ï¼šè‡ªè¡Œç®¡ç† MCP å®¢æˆ·ç«¯

æœ¬ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•è‡ªè¡Œç®¡ç†ä½ è‡ªå·±çš„ MCP å®¢æˆ·ç«¯ï¼Œå¹¶ä½¿ç”¨å®ƒè·å– LangChain å·¥å…·ã€‚è¿™äº›å·¥å…·å¯ä»¥åœ¨ä»»ä½•ä½¿ç”¨ LangChain å·¥å…·çš„åœ°æ–¹ä½¿ç”¨ï¼ŒåŒ…æ‹¬ä¸ LangGraph é¢„æ„å»ºä»£ç†ä¸€èµ·ä½¿ç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

ä»¥ä¸‹ç¤ºä¾‹éœ€è¦æ»¡è¶³ä¸€äº›å‰ææ¡ä»¶ï¼š
```bash
npm install @langchain/mcp-adapters @langchain/langgraph @langchain/core @langchain/openai

export OPENAI_API_KEY=<ä½ çš„_api_key>
```
# ç®€ä»‹

æœ¬èŠ‚ç®€è¦ä»‹ç» [Docker](https://www.docker.com/) ä»¥åŠå®ƒä¸ºä½•å¦‚æ­¤æœ‰ç”¨ã€‚

## Docker æ˜¯ä»€ä¹ˆï¼Ÿ

Docker æ˜¯ä¸€ç§å®¹å™¨åŒ–å¹³å°ï¼Œå…è®¸ä½ å°†åº”ç”¨ç¨‹åºåŠå…¶æ‰€æœ‰ä¾èµ–é¡¹æ‰“åŒ…åˆ°ä¸€ä¸ªæ ‡å‡†åŒ–çš„å•å…ƒä¸­ï¼Œè¿™ä¸ªå•å…ƒè¢«ç§°ä¸º**å®¹å™¨**ã€‚å®¹å™¨æ˜¯ä¸€ä¸ªè½»é‡çº§ã€ç‹¬ç«‹çš„å¯æ‰§è¡Œè½¯ä»¶åŒ…ï¼ŒåŒ…å«è¿è¡Œåº”ç”¨ç¨‹åºæ‰€éœ€çš„ä¸€åˆ‡å†…å®¹ï¼šä»£ç ã€è¿è¡Œæ—¶ã€åº“ã€ç¯å¢ƒå˜é‡å’Œé…ç½®æ–‡ä»¶ã€‚

ä¸è™šæ‹Ÿæœºï¼ˆVMï¼‰ä¸åŒï¼Œå®¹å™¨ä¸ä¼šæ†ç»‘æ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶çš„å®Œæ•´å‰¯æœ¬ï¼Œè€Œæ˜¯å…±äº«ä¸»æœºç³»ç»Ÿçš„æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œä»è€Œä½¿å…¶æ›´åŠ è½»é‡ä¸”å¯åŠ¨æ›´å¿«ã€‚

## ä¸ºä»€ä¹ˆä½¿ç”¨ Dockerï¼Ÿ

ä»¥ä¸‹æ˜¯ä½¿ç”¨ Docker çš„ä¸€äº›ä¸»è¦ä¼˜åŠ¿ï¼š

- **ä¸€è‡´æ€§**ï¼šåœ¨æœ¬åœ°å¼€å‘çš„ä»£ç å¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä»¥ç›¸åŒçš„æ–¹å¼è¿è¡Œï¼ˆâ€œåœ¨æˆ‘æœºå™¨ä¸Šèƒ½è¿è¡Œâ€é—®é¢˜çš„ç»ˆç»“è€…ï¼‰ã€‚
- **éš”ç¦»æ€§**ï¼šåº”ç”¨ç¨‹åºåœ¨éš”ç¦»çš„ç¯å¢ƒä¸­è¿è¡Œï¼Œé¿å…äº†ä¾èµ–å†²çªã€‚
- **å¯ç§»æ¤æ€§**ï¼šå®¹å™¨å¯ä»¥åœ¨ä»»ä½•å®‰è£…äº† Docker çš„æœºå™¨ä¸Šè¿è¡Œï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚
- **å¯æ‰©å±•æ€§**ï¼šå¯ä»¥è½»æ¾åˆ›å»ºå¤šä¸ªå®¹å™¨å®ä¾‹æ¥å¤„ç†é«˜è´Ÿè½½ã€‚
- **é«˜æ•ˆæ€§**ï¼šç›¸æ¯”è™šæ‹Ÿæœºï¼Œå®¹å™¨æ›´è½»é‡ï¼Œèµ„æºæ¶ˆè€—æ›´å°‘ï¼Œå¯åŠ¨æ›´å¿«ã€‚

## Docker ç”Ÿæ€ç³»ç»Ÿæ ¸å¿ƒç»„ä»¶

- **Docker å¼•æ“ï¼ˆDocker Engineï¼‰**ï¼šè¿è¡Œå®¹å™¨çš„å¼•æ“ï¼ŒåŒ…æ‹¬ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ã€ä¸€ä¸ª REST API å’Œä¸€ä¸ªå‘½ä»¤è¡Œæ¥å£ï¼ˆCLIï¼‰ã€‚
- **Docker é•œåƒï¼ˆImageï¼‰**ï¼šä¸€ä¸ªåªè¯»æ¨¡æ¿ï¼ŒåŒ…å«åˆ›å»ºå®¹å™¨æ‰€éœ€çš„æŒ‡ä»¤ã€‚
- **Docker å®¹å™¨ï¼ˆContainerï¼‰**ï¼šé•œåƒçš„è¿è¡Œå®ä¾‹ã€‚
- **Dockerfile**ï¼šä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼ŒåŒ…å«ç”¨äºæ„å»ºé•œåƒçš„æŒ‡ä»¤ã€‚
- **Docker Hub**ï¼šä¸€ä¸ªå…¬å…±æ³¨å†Œä¸­å¿ƒï¼Œç”¨äºå­˜å‚¨å’Œå…±äº«é•œåƒã€‚
- **Docker Compose**ï¼šä¸€ä¸ªç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨ Docker åº”ç”¨ç¨‹åºçš„å·¥å…·ã€‚

## ç¤ºä¾‹ Dockerfile

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ `Dockerfile` ç¤ºä¾‹ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ªè¿è¡Œ Python åº”ç”¨ç¨‹åºçš„é•œåƒï¼š

```Dockerfile
# ä½¿ç”¨å®˜æ–¹ Python é•œåƒä½œä¸ºåŸºç¡€é•œåƒ
FROM python:3.9-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å°†å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶å¤åˆ¶åˆ°å·¥ä½œç›®å½•ä¸­
COPY . /app

# å®‰è£…ä¾èµ–
RUN pip install --no-cache-dir -r requirements.txt

# æŒ‡å®šå®¹å™¨å¯åŠ¨æ—¶è¿è¡Œçš„å‘½ä»¤
CMD ["python", "app.py"]
```

## å¸¸ç”¨å‘½ä»¤

ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„ Docker å‘½ä»¤ï¼š

- æ„å»ºé•œåƒï¼š
  ```bash
  docker build -t my-app .
  ```

- åˆ—å‡ºæœ¬åœ°é•œåƒï¼š
  ```bash
  docker images
  ```

- è¿è¡Œå®¹å™¨ï¼š
  ```bash
  docker run -d -p 8000:8000 my-app
  ```

- åˆ—å‡ºæ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼š
  ```bash
  docker ps
  ```

- åœæ­¢å®¹å™¨ï¼š
  ```bash
  docker stop <container_id>
  ```

- åˆ é™¤é•œåƒï¼š
  ```bash
  docker rmi <image_id>
  ```

## æ€»ç»“

Docker æä¾›äº†ä¸€ç§é«˜æ•ˆã€çµæ´»çš„æ–¹å¼æ¥å¼€å‘ã€éƒ¨ç½²å’Œè¿è¡Œåº”ç”¨ç¨‹åºã€‚é€šè¿‡å®¹å™¨åŒ–æŠ€æœ¯ï¼Œå®ƒè§£å†³äº†â€œåœ¨æˆ‘æœºå™¨ä¸Šèƒ½è¿è¡Œâ€çš„é—®é¢˜ï¼Œå¹¶ç®€åŒ–äº†è·¨ä¸åŒç¯å¢ƒçš„åº”ç”¨äº¤ä»˜æµç¨‹ã€‚æ— è®ºä½ æ˜¯å¼€å‘äººå‘˜ã€æµ‹è¯•äººå‘˜è¿˜æ˜¯è¿ç»´å·¥ç¨‹å¸ˆï¼ŒæŒæ¡ Docker éƒ½å°†æå¤§æå‡ä½ çš„å·¥ä½œæ•ˆç‡å’Œéƒ¨ç½²å¯é æ€§ã€‚
```ts
import { Client } from "@modelcontextprotocol/sdk/client/index.js";
import { StdioClientTransport } from "@modelcontextprotocol/sdk/client/stdio.js";
import { ChatOpenAI } from "@langchain/openai";
import { createReactAgent } from "@langchain/langgraph/prebuilt";
import { loadMcpTools } from "@langchain/mcp-adapters";

// åˆå§‹åŒ– ChatOpenAI æ¨¡å‹
const model = new ChatOpenAI({ model: "gpt-4" });

// è‡ªåŠ¨å¯åŠ¨å¹¶è¿æ¥åˆ° MCP å‚è€ƒæœåŠ¡å™¨
const transport = new StdioClientTransport({
  command: "npx",
  args: ["-y", "@modelcontextprotocol/server-math"],
});

// åˆå§‹åŒ–å®¢æˆ·ç«¯
const client = new Client({
  name: "math-client",
  version: "1.0.0",
});

try {
  // è¿æ¥ä¼ è¾“é€šé“
  await client.connect(transport);

  // è·å–å¸¦æœ‰è‡ªå®šä¹‰é…ç½®çš„å·¥å…·
  const tools = await loadMcpTools("math", client, {
    // å¦‚æœå·¥å…·åŠ è½½å¤±è´¥æ˜¯å¦æŠ›å‡ºé”™è¯¯ï¼ˆå¯é€‰ï¼Œé»˜è®¤å€¼ï¼štrueï¼‰
    throwOnLoadError: true,
    // æ˜¯å¦åœ¨å·¥å…·åç§°å‰åŠ ä¸ŠæœåŠ¡å™¨åç§°ï¼ˆå¯é€‰ï¼Œé»˜è®¤å€¼ï¼šfalseï¼‰
    prefixToolNameWithServerName: false,
    // å·¥å…·åç§°çš„å¯é€‰é™„åŠ å‰ç¼€ï¼ˆå¯é€‰ï¼Œé»˜è®¤å€¼ï¼šç©ºå­—ç¬¦ä¸²ï¼‰
    additionalToolNamePrefix: "",
    // åœ¨å·¥å…·è¾“å‡ºä¸­ä½¿ç”¨æ ‡å‡†åŒ–å†…å®¹å—æ ¼å¼ï¼ˆé»˜è®¤å€¼ï¼šfalseï¼‰
    useStandardContentBlocks: false,
  });

  // åˆ›å»ºå¹¶è¿è¡Œä»£ç†
  const agent = createReactAgent({ llm: model, tools });
  const agentResponse = await agent.invoke({
    messages: [{ role: "user", content: "(3 + 5) x 12 ç­‰äºå¤šå°‘ï¼Ÿ" }],
  });
  console.log(agentResponse);
} catch (e) {
  console.error(e);
} finally {
  // æ¸…ç†è¿æ¥
  await client.close();
}
```
æœ‰å…³æ›´è¯¦ç»†çš„ç¤ºä¾‹ï¼Œè¯·å‚é˜… [examples](https://github.com/langchain-ai/langchainjs/tree/main/libs/langchain-mcp-adapters/examples) ç›®å½•ã€‚

## å·¥å…·é…ç½®é€‰é¡¹

> \[!æç¤º]
> ä¸ºäº†å‘åå…¼å®¹ï¼Œ`useStandardContentBlocks` é»˜è®¤ä¸º `false`ï¼Œä½†å»ºè®®æ–°åº”ç”¨ç¨‹åºå°†å…¶è®¾ç½®ä¸º `true`ï¼Œå› ä¸ºæœªæ¥ç‰ˆæœ¬å¯èƒ½ä¼šå°†å…¶è®¾ä¸ºé»˜è®¤å€¼ã€‚

å½“é€šè¿‡ `loadMcpTools` ç›´æ¥åŠ è½½ MCP å·¥å…·æˆ–é€šè¿‡ `MultiServerMCPClient` åŠ è½½æ—¶ï¼Œæ‚¨å¯ä»¥é…ç½®ä»¥ä¸‹é€‰é¡¹ï¼š

| é€‰é¡¹                         | ç±»å‹                                   | é»˜è®¤å€¼                                               | æè¿°                                                                          |
| ------------------------------ | -------------------------------------- | ----------------------------------------------------- | ------------------------------------------------------------------------------------ |
| `throwOnLoadError`             | `boolean`                              | `true`                                                | å¦‚æœå·¥å…·åŠ è½½å¤±è´¥ï¼Œæ˜¯å¦æŠ›å‡ºé”™è¯¯                                    |
| `prefixToolNameWithServerName` | `boolean`                              | `false`                                               | å¦‚æœä¸º trueï¼Œåˆ™åœ¨æ‰€æœ‰å·¥å…·åç§°å‰åŠ ä¸ŠæœåŠ¡å™¨åç§°ï¼ˆä¾‹å¦‚ï¼Œ`serverName__toolName`ï¼‰ |
| `additionalToolNamePrefix`     | `string`                               | `""`                                                  | è¦æ·»åŠ åˆ°å·¥å…·åç§°çš„é¢å¤–å‰ç¼€ï¼ˆä¾‹å¦‚ï¼Œ`prefix__serverName__toolName`ï¼‰        |
| `useStandardContentBlocks`     | `boolean`                              | `false`                                               | å‚è§ [å·¥å…·è¾“å‡ºæ˜ å°„](#tool-output-mapping)ï¼›æ–°åº”ç”¨ç¨‹åºè¯·è®¾ä¸º true       |
| `outputHandling`               | `"content"`, `"artifact"` æˆ– `object` | `resource` -> `"artifact"`ï¼Œå…¶ä»– -> `"content"` | å‚è§ [å·¥å…·è¾“å‡ºæ˜ å°„](#tool-output-mapping)                                      |
| `defaultToolTimeout`           | `number`                               | `0`                                                   | æ‰€æœ‰å·¥å…·çš„é»˜è®¤è¶…æ—¶æ—¶é—´ï¼ˆå¯åœ¨æ¯ä¸ªå·¥å…·åŸºç¡€ä¸Šè¦†ç›–ï¼‰                      |

## å·¥å…·è¾“å‡ºæ˜ å°„

> \[!æç¤º]
> å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨å¤šæ¨¡æ€å·¥å…·ã€ç”ŸæˆåµŒå…¥èµ„æºçš„å·¥å…·ï¼Œæˆ–ç”Ÿæˆå¯èƒ½ä¸æƒ³åŒ…å«åœ¨ LLM è¾“å…¥ä¸Šä¸‹æ–‡ä¸­çš„å¤§å‹è¾“å‡ºçš„å·¥å…·ï¼Œæœ¬èŠ‚å†…å®¹éå¸¸é‡è¦ã€‚å¦‚æœæ‚¨æ­£åœ¨ç¼–å†™ä¸€ä¸ªä»…ä½¿ç”¨ç”Ÿæˆç®€å•æ–‡æœ¬æˆ– JSON è¾“å‡ºçš„å·¥å…·çš„æ–°åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å»ºè®®å°† `useStandardContentBlocks` è®¾ç½®ä¸º `true` å¹¶ä¿æŒ `outputHandling` æœªå®šä¹‰ï¼ˆå°†ä½¿ç”¨é»˜è®¤å€¼ï¼‰ã€‚

MCP å·¥å…·è¿”å›å†…å®¹å—æ•°ç»„ã€‚å†…å®¹å—å¯ä»¥åŒ…å«æ–‡æœ¬ã€å›¾åƒã€éŸ³é¢‘æˆ–åµŒå…¥èµ„æºã€‚å¦‚ä½•å°†è¿™äº›è¾“å‡ºæ˜ å°„åˆ° LangChain çš„ `ToolMessage` å¯¹è±¡ï¼Œå–å†³äºæ‚¨çš„åº”ç”¨ç¨‹åºéœ€æ±‚ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å¼•å…¥ `useStandardContentBlocks` å’Œ `outputHandling` é…ç½®é€‰é¡¹çš„åŸå› ã€‚

`useStandardContentBlocks` å­—æ®µå†³å®šå¦‚ä½•å°†å„ä¸ª MCP å†…å®¹å—è½¬æ¢ä¸º LangChain ChatModel æä¾›å•†ï¼ˆä¾‹å¦‚ `ChatOpenAI`ã€`ChatAnthropic` ç­‰ï¼‰èƒ½è¯†åˆ«çš„ç»“æ„ã€‚`outputHandling` å­—æ®µå…è®¸æ‚¨æŒ‡å®šç»™å®šç±»å‹çš„å†…å®¹æ˜¯å‘é€ç»™ LLMï¼Œè¿˜æ˜¯ä¿ç•™ä¾›åº”ç”¨ç¨‹åºåç»­å¤„ç†æ­¥éª¤ä½¿ç”¨ï¼ˆä¾‹å¦‚ï¼Œåœ¨ä»£ç æ‰§è¡Œç¯å¢ƒä¸­ä½¿ç”¨æ•°æ®åº“æŸ¥è¯¢ç”Ÿæˆçš„æ•°æ®å¸§ï¼‰ã€‚

### æ ‡å‡†åŒ–å·¥å…·è¾“å‡ºæ ¼å¼

åœ¨ `@langchain/core` 0.3.48 ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ç»„æ–°çš„å†…å®¹å—ç±»å‹ï¼Œä¸ºå¤šæ¨¡æ€è¾“å…¥æä¾›äº†æ ‡å‡†åŒ–ç»“æ„ã€‚æ­£å¦‚æ‚¨ä»åç§°æ¨æµ‹çš„é‚£æ ·ï¼Œ`useStandardContentBlocks` è®¾ç½®å†³å®š `@langchain/mcp-adapters` æ˜¯å¦å°†å·¥å…·è¾“å‡ºè½¬æ¢ä¸ºæ­¤æ ¼å¼ã€‚ä¸ºäº†ä¸æ—§ç‰ˆæœ¬çš„ `@langchain/mcp-adapters` å‘åå…¼å®¹ï¼Œå®ƒè¿˜å†³å®šæ˜¯å¦è½¬æ¢å·¥å…·æ¶ˆæ¯å·¥ä»¶ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ä¸‹é¢çš„è½¬æ¢è§„åˆ™ã€‚

> \[!é‡è¦] 
> é™¤äº†ä¸€ä¸ªç‰¹æ®Šæƒ…å†µå¤–ï¼Œ`ToolMessage.content` å’Œ `ToolMessage.artifact` å§‹ç»ˆæ˜¯æ ¹æ®ä»¥ä¸‹è§„åˆ™æè¿°çš„å†…å®¹å—å¯¹è±¡æ•°ç»„ã€‚å½“ `outputHandling` é€‰é¡¹å°† `text` è¾“å‡ºè·¯ç”±åˆ° `ToolMessage.content` å­—æ®µï¼Œå¹¶ä¸”å·¥å…·è°ƒç”¨ç”Ÿæˆçš„å”¯ä¸€å†…å®¹å—æ˜¯ `text` å—æ—¶ï¼Œ`ToolMessage.content` å°†æ˜¯ä¸€ä¸ªåŒ…å«å·¥å…·ç”Ÿæˆæ–‡æœ¬å†…å®¹çš„ `string`ã€‚

**å½“ `useStandardContentBlocks` ä¸º `true` æ—¶ï¼ˆæ¨èç”¨äºæ–°åº”ç”¨ç¨‹åºï¼‰ï¼š**

* **æ–‡æœ¬**ï¼šä½œä¸º [`StandardTextBlock`](https://v03.api.js.langchain.com/types/_langchain_core.messages.StandardTextBlock.html) å¯¹è±¡è¿”å›ã€‚
* **å›¾åƒ**ï¼šä½œä¸º base64 [`StandardImageBlock`](https://v03.api.js.langchain.com/types/_langchain_core.messages.StandardImageBlock.html) å¯¹è±¡è¿”å›ã€‚
* **éŸ³é¢‘**ï¼šä½œä¸º base64 [`StandardAudioBlock`](https://v03.api.js.langchain.com/types/_langchain_core.messages.StandardAudioBlock.html) å¯¹è±¡è¿”å›ã€‚
* **åµŒå…¥èµ„æº**ï¼šä½œä¸º [`StandardFileBlock`](https://v03.api.js.langchain.com/types/_langchain_core.messages.StandardFileBlock.html) è¿”å›ï¼Œ`source_type` ä¸º `text` æˆ– `base64`ï¼Œå…·ä½“å–å†³äºèµ„æºæ˜¯äºŒè¿›åˆ¶è¿˜æ˜¯æ–‡æœ¬ã€‚URI èµ„æºå°†ä»æœåŠ¡å™¨ä¸»åŠ¨è·å–ï¼Œè·å–ç»“æœå°†æ ¹æ®è¿™äº›è§„åˆ™è¿”å›ã€‚æˆ‘ä»¬å°†æ‰€æœ‰åµŒå…¥èµ„æº URI è§†ä¸ºæœåŠ¡å™¨å¯è§£æï¼Œä¸ä¼šå°è¯•è·å–å¤–éƒ¨ URIã€‚

**å½“ `useStandardContentBlocks` ä¸º `false` æ—¶ï¼ˆé»˜è®¤å‘åå…¼å®¹ï¼‰ï¼š**

* è·¯ç”±åˆ° `ToolMessage.artifact` çš„å·¥å…·è¾“å‡ºï¼ˆç”± `outputHandling` é€‰é¡¹æ§åˆ¶ï¼‰ï¼š
  * **åµŒå…¥èµ„æº**ï¼šä»…åŒ…å« URI çš„åµŒå…¥èµ„æºå°†ä»æœåŠ¡å™¨ä¸»åŠ¨è·å–ï¼Œè·å–ç»“æœå°†ä¸ç»è¿‡è½¬æ¢å­˜å‚¨åœ¨ artifact æ•°ç»„ä¸­ã€‚å…¶ä»–æƒ…å†µä¸‹ï¼ŒåµŒå…¥èµ„æºä»¥åŸå§‹ MCP å†…å®¹å—ç»“æ„å­˜å‚¨åœ¨ `artifact` æ•°ç»„ä¸­è€Œä¸ä¿®æ”¹ã€‚
  * **æ‰€æœ‰å…¶ä»–å†…å®¹ç±»å‹**ï¼šä»¥åŸå§‹ MCP å†…å®¹å—ç»“æ„å­˜å‚¨åœ¨ `artifact` æ•°ç»„ä¸­è€Œä¸ä¿®æ”¹ã€‚
* è·¯ç”±åˆ° `ToolMessage.content` æ•°ç»„çš„å·¥å…·è¾“å‡ºï¼ˆç”± `outputHandling` é€‰é¡¹æ§åˆ¶ï¼‰ï¼š
  * **æ–‡æœ¬**ï¼šä½œä¸º [`MessageContentText`](https://v03.api.js.langchain.com/types/_langchain_core.messages.MessageContentText.html) å¯¹è±¡è¿”å›ï¼Œé™¤éå®ƒæ˜¯è¾“å‡ºä¸­å”¯ä¸€çš„å†…å®¹å—ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒå°†ç›´æ¥ä½œä¸º `string` èµ‹å€¼ç»™ `ToolMessage.content`ã€‚
  * **å›¾åƒ**ï¼šä½œä¸º [`MessageContentImageUrl`](https://v03.api.js.langchain.com/types/_langchain_core.messages.MessageContentImageUrl.html) å¯¹è±¡è¿”å›ï¼Œä½¿ç”¨ base64 æ•°æ® URLï¼ˆ`data:image/png;base64,<data>`ï¼‰
  * **éŸ³é¢‘**ï¼šä½œä¸º [`StandardAudioBlock`](https://v03.api.js.langchain.com/types/_langchain_core.messages.StandardAudioBlock.html) å¯¹è±¡è¿”å›ã€‚
  * **åµŒå…¥èµ„æº**ï¼šä½œä¸º [`StandardFileBlock`](https://v03.api.js.langchain.com/types/_langchain_core.messages.StandardFileBlock.html) è¿”å›ï¼Œ`source_type` ä¸º `text` æˆ– `base64`ï¼Œå…·ä½“å–å†³äºèµ„æºæ˜¯äºŒè¿›åˆ¶è¿˜æ˜¯æ–‡æœ¬ã€‚URI èµ„æºå°†ä»æœåŠ¡å™¨ä¸»åŠ¨è·å–ï¼Œè·å–ç»“æœå°†æ ¹æ®è¿™äº›è§„åˆ™è¿”å›ã€‚æˆ‘ä»¬å°†æ‰€æœ‰åµŒå…¥èµ„æº URI è§†ä¸ºæœåŠ¡å™¨å¯è§£æï¼Œä¸ä¼šå°è¯•è·å–å¤–éƒ¨ URIã€‚

### ç¡®å®šå“ªäº›å·¥å…·è¾“å‡ºå¯¹ LLM å¯è§

`outputHandling` é€‰é¡¹å…è®¸æ‚¨ç¡®å®šå“ªäº›å·¥å…·è¾“å‡ºç±»å‹åˆ†é…ç»™ `ToolMessage.content`ï¼Œå“ªäº›åˆ†é…ç»™ `ToolMessage.artifact`ã€‚å½“è°ƒç”¨ LLM æ—¶ï¼Œ[`ToolMessage.content`](https://v03.api.js.langchain.com/classes/_langchain_core.messages_tool.ToolMessage.html#content) ä¸­çš„æ•°æ®å°†ç”¨ä½œè¾“å…¥ä¸Šä¸‹æ–‡ï¼Œè€Œ [`ToolMessage.artifact`](https://v03.api.js.langchain.com/classes/_langchain_core.messages_tool.ToolMessage.html#artifact) ä¸­çš„æ•°æ®åˆ™ä¸ä¼šã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`@langchain/mcp-adapters` å°† MCP `resource` å†…å®¹å—æ˜ å°„åˆ° `ToolMessage.artifact`ï¼Œå¹¶å°†æ‰€æœ‰å…¶ä»– MCP å†…å®¹å—ç±»å‹æ˜ å°„åˆ° `ToolMessage.content`ã€‚[`useStandardContentBlocks`](#standardizing-the-format-of-tool-outputs) çš„å€¼å†³å®šäº†åœ¨æ­¤è¿‡ç¨‹ä¸­æ¯ä¸ªå†…å®¹å—çš„ç»“æ„å¦‚ä½•è½¬æ¢ã€‚

> \[!æç¤º]
> `ToolMessage.artifact` æœ‰ç”¨çš„ç¤ºä¾‹åŒ…æ‹¬ï¼šå½“æ‚¨éœ€è¦é€šè¿‡ `HumanMessage` æˆ– `SystemMessage` å‘é€å¤šæ¨¡æ€å·¥å…·è¾“å‡ºï¼Œä½† LLM æä¾›å•† API ä¸æ¥å—å¤šæ¨¡æ€å·¥å…·è¾“å‡ºï¼Œæˆ–ä¸€ä¸ªå·¥å…·å¯èƒ½ç”Ÿæˆå¤§å‹è¾“å‡ºä¾›å…¶ä»–å·¥å…·é—´æ¥æ“ä½œçš„æƒ…å†µï¼ˆä¾‹å¦‚ï¼ŒæŸ¥è¯¢å·¥å…·å°†æ•°æ®å¸§åŠ è½½åˆ° Python ä»£ç æ‰§è¡Œç¯å¢ƒä¸­ï¼‰ã€‚

`outputHandling` é€‰é¡¹å¯ä»¥èµ‹å€¼ä¸º `"content"`ã€`"artifact"`ï¼Œæˆ–ä¸€ä¸ªå°† MCP å†…å®¹å—ç±»å‹æ˜ å°„ä¸º `content` æˆ– `artifact` çš„å¯¹è±¡ã€‚

ä½¿ç”¨ `MultiServerMCPClient` æ—¶ï¼Œ`outputHandling` å­—æ®µå¯ä»¥èµ‹å€¼ç»™é¡¶çº§é…ç½®å¯¹è±¡å’Œ/æˆ– `mcpServers` ä¸­çš„å„ä¸ªæœåŠ¡å™¨æ¡ç›®ã€‚`mcpServers` ä¸­çš„æ¡ç›®ä¼šè¦†ç›–é¡¶çº§é…ç½®ä¸­çš„æ¡ç›®ï¼Œè€Œé¡¶çº§é…ç½®ä¸­çš„æ¡ç›®ä¼šè¦†ç›–é»˜è®¤å€¼ã€‚

ä¾‹å¦‚ï¼Œè€ƒè™‘ä»¥ä¸‹é…ç½®ï¼š
```typescript
const clientConfig = {
  useStandardContentBlocks: true,
  outputHandling: {
    image: "artifact",
    audio: "artifact",
  },
  mcpServers: {
    "camera-server": {
      url: "...",
      outputHandling: {
        image: content
      },
    },
    microphone: {
      url: "...",
      outputHandling: {
        audio: content
      },
    },
  },
}
```
è°ƒç”¨ `camera` MCP æœåŠ¡å™¨ä¸­çš„å·¥å…·æ—¶ï¼Œå°†ä½¿ç”¨ä»¥ä¸‹ `outputHandling` é…ç½®ï¼š
```typescript
{
  text: "content", // é»˜è®¤å€¼
  image: "content", // é»˜è®¤å€¼ï¼Œä¸”è¢« "camera" æœåŠ¡å™¨é…ç½®è¦†ç›–çš„é¡¶å±‚é…ç½®
  audio: "artifact", // è¢«é¡¶å±‚é…ç½®è¦†ç›–çš„é»˜è®¤å€¼
  resource: "artifact", // é»˜è®¤å€¼
}
```
åŒæ ·ï¼Œåœ¨è°ƒç”¨ `microphone` MCP æœåŠ¡å™¨ä¸Šçš„å·¥å…·æ—¶ï¼Œå°†ä½¿ç”¨ä»¥ä¸‹ `outputHandling` é…ç½®ï¼š
```typescript
{
  text: "å†…å®¹", // é»˜è®¤å€¼
  image: "å·¥ä»¶", // é¡¶å±‚é…ç½®è¦†ç›–çš„é»˜è®¤å€¼
  audio: "å†…å®¹", // é»˜è®¤å€¼åŠé¡¶å±‚é…ç½®è¢« "microphone" æœåŠ¡å™¨é…ç½®è¦†ç›–
  resource: "å·¥ä»¶", // é»˜è®¤å€¼
}
```
## å·¥å…·è¶…æ—¶é…ç½®

### ä½¿ç”¨ `defaultToolTimeout`

æ‚¨å¯ä»¥é€šè¿‡åœ¨å®¢æˆ·ç«¯å‚æ•°ä¸­è®¾ç½® `defaultToolTimeout` å­—æ®µï¼Œä¸ºæ‰€æœ‰å·¥å…·é…ç½®å…¨å±€è¶…æ—¶æ—¶é—´ã€‚æ‚¨å¯ä»¥åœ¨æœåŠ¡å™¨é…ç½®ä¸­åŒ…å« `defaultToolTimeout` å­—æ®µï¼Œä»¥ä¸ºè¯¥æœåŠ¡å™¨çš„æ‰€æœ‰å·¥å…·è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œæˆ–è€…åœ¨é¡¶çº§é…ç½®ä¸­è®¾ç½®å®ƒï¼Œä»¥ä¸ºæ•´ä¸ªå®¢æˆ·ç«¯è®¾ç½®å…¨å±€è¶…æ—¶æ—¶é—´ã€‚

é™¤éè¢«ç‰¹å®šå·¥å…·çš„è¶…æ—¶è®¾ç½®æ‰€è¦†ç›–ï¼Œå¦åˆ™æ‰€æœ‰å·¥å…·éƒ½å°†ä½¿ç”¨æ­¤è¶…æ—¶ä½œä¸ºé»˜è®¤è¶…æ—¶æ—¶é—´ã€‚
```typescript
const client = new MultiServerMCPClient({
  mcpServers: {
    "data-processor": {
      command: "python",
      args: ["data_server.py"],
      defaultToolTimeout: 30000, // è¶…æ—¶æ—¶é—´ä¸º30ç§’
    },
    "image-processor": {
      transport: "stdio",
      command: "node",
      args: ["image_server.js"],
      // è¶…æ—¶æ—¶é—´ä¸º10ç§’ï¼ˆåœ¨é¡¶å±‚é…ç½®ä¸­è®¾ç½®ï¼‰
    },
  },
  defaultToolTimeout: 10000, // 10ç§’
});

const tools = await client.getTools();
const slowTool = tools.find((t) => t.name.includes("process_large_dataset"));

// å°†åœ¨30ç§’åè¶…æ—¶ï¼ˆdefaultToolTimeoutï¼‰
const result = await slowTool.invoke({ dataset: "huge_file.csv" });
```
### ä½¿ç”¨ `withConfig`

MCP å·¥å…·é€šè¿‡ LangChain æ ‡å‡†çš„ `RunnableConfig` æ¥å£æ”¯æŒè¶…æ—¶é…ç½®ã€‚è¿™å…è®¸ä½ åœ¨æ¯æ¬¡è°ƒç”¨å·¥å…·æ—¶è®¾ç½®è‡ªå®šä¹‰çš„è¶…æ—¶æ—¶é—´ï¼š
```typescript
const client = new MultiServerMCPClient({
  mcpServers: {
    "data-processor": {
      command: "python",
      args: ["data_server.py"],
    },
  },
  useStandardContentBlocks: true,
});

const tools = await client.getTools();
const slowTool = tools.find((t) => t.name.includes("process_large_dataset"));

// æ‚¨å¯ä»¥ä½¿ç”¨ withConfig åœ¨å°†å·¥å…·ä¼ é€’ç»™ LangGraph ToolNode æˆ–åº”ç”¨ç¨‹åºå…¶ä»–éƒ¨åˆ†ä¹‹å‰
// è®¾ç½®ç‰¹å®šäºè¯¥å·¥å…·çš„è¶…æ—¶æ—¶é—´
const slowToolWithTimeout = slowTool.withConfig({ timeout: 300000 }); // 5 åˆ†é’Ÿè¶…æ—¶

// æ­¤è°ƒç”¨å°†éµå¾ª 5 åˆ†é’Ÿè¶…æ—¶é™åˆ¶
const result = await slowToolWithTimeout.invoke({ dataset: "huge_file.csv" });

// æˆ–è€…æ‚¨ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨ withConfig è€Œç›´æ¥è°ƒç”¨
const directResult = await slowTool.invoke(
  { dataset: "huge_file.csv" },
  { timeout: 300000 }
);

// å¿«é€Ÿæ“ä½œçš„çŸ­è¶…æ—¶æ—¶é—´
const quickResult = await fastTool.invoke(
  { query: "simple_lookup" },
  { timeout: 5000 } // 5 ç§’é’Ÿ
);

// æœªæä¾›é…ç½®æ—¶çš„é»˜è®¤è¶…æ—¶æ—¶é—´ï¼ˆæ¥è‡ª MCP SDK çš„ 60 ç§’ï¼‰
const normalResult = await tool.invoke({ input: "normal_processing" });
```
å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ `RunnableConfig` å­—æ®µé…ç½®è¶…æ—¶ï¼š

| å‚æ•°      | ç±»å‹          | é»˜è®¤å€¼    | æè¿°                                                         |
| --------- | ------------- | --------- | ------------------------------------------------------------ |
| `timeout` | number        | 60000     | å·¥å…·è°ƒç”¨çš„è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰                                   |
| `signal`  | AbortSignal   | undefined | ä¸€ä¸ª AbortSignalï¼Œå½“è¢«è§¦å‘æ—¶ï¼Œå°†å–æ¶ˆå·¥å…·è°ƒç”¨                 |

## OAuth 2.0 è®¤è¯

å¯¹äºéœ€è¦ OAuth 2.0 è®¤è¯çš„å®‰å…¨ MCP æœåŠ¡å™¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `authProvider` é€‰é¡¹ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨ç®¡ç†è¯·æ±‚å¤´ã€‚è¿™æä¾›äº†è‡ªåŠ¨åˆ·æ–°ä»¤ç‰Œã€é”™è¯¯å¤„ç†ä»¥åŠç¬¦åˆæ ‡å‡†çš„ OAuth æµç¨‹ã€‚

v0.4.6 ç‰ˆæœ¬æ–°å¢åŠŸèƒ½ã€‚

### åŸºæœ¬ OAuth é…ç½®
```ts
import type { OAuthClientProvider } from "@modelcontextprotocol/sdk/client/auth.js";

class MyOAuthProvider implements OAuthClientProvider {
  constructor(
    private config: {
      redirectUrl: string;
      clientMetadata: OAuthClientMetadata;
    }
  ) {}

  get redirectUrl() {
    return this.config.redirectUrl;
  }
  get clientMetadata() {
    return this.config.clientMetadata;
  }

  // å®ç°ä»¤ç‰Œå­˜å‚¨ï¼ˆlocalStorageã€æ•°æ®åº“ç­‰ï¼‰
  tokens(): OAuthTokens | undefined {
    const stored = localStorage.getItem("mcp_tokens");
    return stored ? JSON.parse(stored) : undefined;
  }

  async saveTokens(tokens: OAuthTokens): Promise<void> {
    localStorage.setItem("mcp_tokens", JSON.stringify(tokens));
  }

  // å®ç°å…¶ä»–å¿…éœ€çš„æ–¹æ³•...
  // å®Œæ•´ç¤ºä¾‹è¯·å‚é˜… MCP SDK æ–‡æ¡£
}

const client = new MultiServerMCPClient({
  mcpServers: {
    "secure-server": {
      url: "https://secure-mcp-server.example.com/mcp",
      authProvider: new MyOAuthProvider({
        redirectUrl: "https://myapp.com/oauth/callback",
        clientMetadata: {
          redirect_uris: ["https://myapp.com/oauth/callback"],
          client_name: "My MCP Client",
          scope: "mcp:read mcp:write",
        },
      }),
    },
  },
  useStandardContentBlocks: true,
});
```
### OAuth ç‰¹æ€§

`authProvider` ä¼šè‡ªåŠ¨å¤„ç†ï¼š

* âœ… **ä»¤ç‰Œåˆ·æ–°**ï¼šä½¿ç”¨åˆ·æ–°ä»¤ç‰Œè‡ªåŠ¨åˆ·æ–°è¿‡æœŸçš„è®¿é—®ä»¤ç‰Œ  
* âœ… **401 é”™è¯¯æ¢å¤**ï¼šåœ¨æˆåŠŸé‡æ–°è®¤è¯åè‡ªåŠ¨é‡è¯•è¯·æ±‚  
* âœ… **PKCE å®‰å…¨æœºåˆ¶**ï¼šä½¿ç”¨â€œä»£ç äº¤æ¢çš„è¯æ˜å¯†é’¥â€ï¼ˆProof Key for Code Exchangeï¼‰ä»¥å¢å¼ºå®‰å…¨æ€§  
* âœ… **éµå¾ªæ ‡å‡†**ï¼šç¬¦åˆ OAuth 2.0 å’Œ RFC 6750 è§„èŒƒ  
* âœ… **ä¼ è¾“å…¼å®¹æ€§**ï¼šåŒæ—¶æ”¯æŒ StreamableHTTP å’Œ SSE ä¼ è¾“æ–¹å¼  

### OAuth ä¸æ‰‹åŠ¨å¤´éƒ¨å¯¹æ¯”

| æ–¹é¢             | OAuth æä¾›è€…           | æ‰‹åŠ¨å¤´éƒ¨è®¾ç½®                    |
| ---------------- | ---------------------- | ------------------------------- |
| **ä»¤ç‰Œåˆ·æ–°**     | âœ… è‡ªåŠ¨åˆ·æ–°             | âŒ éœ€è¦æ‰‹åŠ¨å®ç°                  |
| **401 å¤„ç†**     | âœ… è‡ªåŠ¨é‡è¯•             | âŒ éœ€è¦æ‰‹åŠ¨å¤„ç†é”™è¯¯              |
| **å®‰å…¨æ€§**       | âœ… PKCEï¼Œå®‰å…¨æµç¨‹       | âš ï¸ å–å†³äºå…·ä½“å®ç°               |
| **æ ‡å‡†åˆè§„æ€§**   | âœ… ç¬¦åˆ RFC 6750 æ ‡å‡†   | âš ï¸ éœ€è¦æ‰‹åŠ¨ç¡®ä¿ç¬¦åˆè§„èŒƒ         |
| **å¤æ‚åº¦**       | âœ… é…ç½®ç®€å•             | âŒ å®ç°è¾ƒå¤æ‚                   |

**å»ºè®®**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒçš„ OAuth æœåŠ¡å™¨ä¸­ä½¿ç”¨ `authProvider`ï¼Œä»…åœ¨ç®€å•çš„åŸºäºä»¤ç‰Œçš„è®¤è¯æˆ–è°ƒè¯•æ—¶ä½¿ç”¨ `headers`ã€‚

## é‡è¿ç­–ç•¥

ä¸¤ç§ä¼ è¾“æ–¹å¼éƒ½æ”¯æŒè‡ªåŠ¨é‡è¿ï¼š

### Stdio ä¼ è¾“é‡å¯
```ts
{
  transport: "stdio",
  command: "npx",
  args: ["-y", "@modelcontextprotocol/server-math"],
  restart: {
    enabled: true,      // å¯ç”¨è‡ªåŠ¨é‡å¯
    maxAttempts: 3,     // æœ€å¤§é‡å¯å°è¯•æ¬¡æ•°
    delayMs: 1000       // å°è¯•ä¹‹é—´çš„å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  }
}
```
### SSE ä¼ è¾“é‡è¿
```ts
{
  transport: "sse",
  url: "https://example.com/mcp-server",
  headers: { "Authorization": "Bearer token123" },
  reconnect: {
    enabled: true,      // å¯ç”¨è‡ªåŠ¨é‡è¿
    maxAttempts: 5,     // æœ€å¤§é‡è¿æ¬¡æ•°
    delayMs: 2000       // ä¸¤æ¬¡é‡è¿ä¹‹é—´çš„å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
  }
}
```
## é”™è¯¯å¤„ç†

è¯¥åº“æä¾›äº†ä¸åŒçš„é”™è¯¯ç±»å‹ä»¥å¸®åŠ©è°ƒè¯•ï¼š

* **MCPClientError**ï¼šç”¨äºå®¢æˆ·ç«¯è¿æ¥å’Œåˆå§‹åŒ–é—®é¢˜
* **ToolException**ï¼šç”¨äºå·¥å…·æ‰§è¡ŒæœŸé—´çš„é”™è¯¯
* **ZodError**ï¼šç”¨äºé…ç½®éªŒè¯é”™è¯¯ï¼ˆè¿æ¥è®¾ç½®æ— æ•ˆç­‰ï¼‰

ç¤ºä¾‹é”™è¯¯å¤„ç†ï¼š
```ts
try {
  const client = new MultiServerMCPClient({
    mcpServers: {
      math: {
        transport: "stdio",
        command: "npx",
        args: ["-y", "@modelcontextprotocol/server-math"],
      },
    },
    useStandardContentBlocks: true,
  });

  const tools = await client.getTools();
  const result = await tools[0].invoke({ expression: "1 + 2" });
} catch (error) {
  if (error.name === "MCPClientError") {
    // å¤„ç†è¿æ¥é—®é¢˜
    console.error(`è¿æ¥é”™è¯¯ (${error.serverName}):`, error.message);
  } else if (error.name === "ToolException") {
    // å¤„ç†å·¥å…·æ‰§è¡Œé”™è¯¯
    console.error("å·¥å…·æ‰§è¡Œå¤±è´¥:", error.message);
  } else if (error.name === "ZodError") {
    // å¤„ç†é…ç½®éªŒè¯é”™è¯¯
    console.error("é…ç½®é”™è¯¯:", error.issues);
    // Zod é”™è¯¯åŒ…å«å…³äºé—®é¢˜çš„è¯¦ç»†ä¿¡æ¯
    error.issues.forEach((issue) => {
      console.error(`- è·¯å¾„: ${issue.path.join(".")}, é”™è¯¯: ${issue.message}`);
    });
  } else {
    // å¤„ç†å…¶ä»–é”™è¯¯
    console.error("æ„å¤–é”™è¯¯:", error);
  }
}
```
### å¸¸è§çš„ Zod æ ¡éªŒé”™è¯¯

è¯¥åº“ä½¿ç”¨ Zod è¿›è¡Œé…ç½®æ ¡éªŒã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„æ ¡éªŒé”™è¯¯ï¼š

* **ç¼ºå°‘å¿…å¡«å‚æ•°**ï¼šä¾‹å¦‚ï¼Œå¯¹äº stdio ä¼ è¾“æ–¹å¼é—æ¼ `command`ï¼Œæˆ–å¯¹äº SSE ä¼ è¾“æ–¹å¼é—æ¼ `url`
* **å‚æ•°ç±»å‹é”™è¯¯**ï¼šä¾‹å¦‚ï¼Œåœ¨æœŸæœ›å­—ç¬¦ä¸²çš„åœ°æ–¹æä¾›äº†æ•°å­—
* **æ— æ•ˆçš„è¿æ¥é…ç½®**ï¼šä¾‹å¦‚ï¼Œå¯¹äº SSE ä¼ è¾“æ–¹å¼ä½¿ç”¨äº†æ— æ•ˆçš„ URL æ ¼å¼

æ— æ•ˆ SSE URL çš„ Zod é”™è¯¯ç¤ºä¾‹ï¼š
```json
{
  "issues": [
    {
      "code": "invalid_string",
      "validation": "url",
      "path": ["mcpServers", "weather", "url"],
      "message": "æ— æ•ˆçš„ç½‘å€"
    }
  ],
  "name": "ZodError"
}
```
### è°ƒè¯•æ—¥å¿—

æœ¬åŒ…ä½¿ç”¨ [debug](https://www.npmjs.com/package/debug) åŒ…è¿›è¡Œè°ƒè¯•æ—¥å¿—è®°å½•ã€‚

é»˜è®¤æƒ…å†µä¸‹æ—¥å¿—è®°å½•æ˜¯ç¦ç”¨çš„ï¼Œå¯ä»¥é€šè¿‡æŒ‰ç…§ debug åŒ…ä¸­çš„è¯´æ˜è®¾ç½® `DEBUG` ç¯å¢ƒå˜é‡æ¥å¯ç”¨ã€‚

è¦è¾“å‡ºæœ¬åŒ…çš„æ‰€æœ‰è°ƒè¯•æ—¥å¿—ï¼š
```bash
DEBUG='@langchain/mcp-adapters:*'
```
ä»…ä» `client` æ¨¡å—è¾“å‡ºè°ƒè¯•æ—¥å¿—ï¼š
```bash
DEBUG='@langchain/mcp-adapters:client'
```
ä»…ä» `tools` æ¨¡å—è¾“å‡ºè°ƒè¯•æ—¥å¿—ï¼š
```bash
DEBUG='@langchain/mcp-adapters:tools'
```
## è®¸å¯è¯

MIT

## è‡´è°¢

éå¸¸æ„Ÿè°¢ [@vrknetha](https://github.com/vrknetha) å’Œ [@knacklabs](https://www.knacklabs.ai)ï¼Œæ„Ÿè°¢ä½ ä»¬çš„åˆå§‹å®ç°ï¼

## è´¡çŒ®

æˆ‘ä»¬æ¬¢è¿è´¡çŒ®ï¼æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹æˆ‘ä»¬çš„[è´¡çŒ®æŒ‡å—](https://github.com/langchain-ai/langchainjs/tree/main/libs/langchain-mcp-adapters/CONTRIBUTING.md)ã€‚